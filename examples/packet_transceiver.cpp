#include <gnuradio-4.0/Graph.hpp>
#include <gnuradio-4.0/Scheduler.hpp>
#include <gnuradio-4.0/packet-modem/add.hpp>
#include <gnuradio-4.0/packet-modem/message_debug.hpp>
#include <gnuradio-4.0/packet-modem/noise_source.hpp>
#include <gnuradio-4.0/packet-modem/packet_receiver.hpp>
#include <gnuradio-4.0/packet-modem/packet_to_stream.hpp>
#include <gnuradio-4.0/packet-modem/packet_transmitter_pdu.hpp>
#include <gnuradio-4.0/packet-modem/pfb_arb_resampler.hpp>
#include <gnuradio-4.0/packet-modem/probe_rate.hpp>
#include <gnuradio-4.0/packet-modem/rotator.hpp>
#include <gnuradio-4.0/packet-modem/tagged_stream_to_pdu.hpp>
#include <gnuradio-4.0/packet-modem/throttle.hpp>
#include <gnuradio-4.0/packet-modem/tun_sink.hpp>
#include <gnuradio-4.0/packet-modem/tun_source.hpp>
#include <boost/ut.hpp>
#include <complex>
#include <cstdint>

// Generated with
//   pm_remez.remez(32*40, [0, 0.45/32, 0.55/32, 0.5], [1, 0], weight=[1, 10])
// This has 80 dB stopband attenuation
static std::vector<float> pfb_arb_taps = {
    -5.134510021745512e-05f,  -4.054793696533239e-06f,  -4.097073284186477e-06f,
    -4.056526894188398e-06f,  -3.928108471024311e-06f,  -3.707254477608423e-06f,
    -3.3900242344043525e-06f, -2.9731319810317487e-06f, -2.454080518541603e-06f,
    -1.8311844907647367e-06f, -1.1036931596126e-06f,    -2.718007740031418e-07f,
    6.632455737403016e-07f,   1.699152398532655e-06f,   2.8324906099084146e-06f,
    4.058722274925803e-06f,   5.372133255689227e-06f,   6.765883156649178e-06f,
    8.231962317204055e-06f,   9.761267025727237e-06f,   1.134358249120489e-05f,
    1.296768445907276e-05f,   1.462134877651063e-05f,   1.6291479466825486e-05f,
    1.7964144381562335e-05f,  1.9624728639943934e-05f,  2.125799467540191e-05f,
    2.284825874712199e-05f,   2.4379472499427122e-05f,  2.58354190690499e-05f,
    2.7199812112700867e-05f,  2.8456506921749016e-05f,  2.9589611811669155e-05f,
    3.058370865174652e-05f,   3.1423970595074046e-05f,  3.209638561052228e-05f,
    3.258787380513695e-05f,   3.288650694016886e-05f,   3.298161812479974e-05f,
    3.286400995058404e-05f,   3.252604913234915e-05f,   3.1961855851965694e-05f,
    3.1167376027591566e-05f,  3.0140544718886587e-05f,  2.8881329139335317e-05f,
    2.7391859567928292e-05f,  2.5676436966620375e-05f,  2.3741625758696218e-05f,
    2.159622098374245e-05f,   1.9251298511794225e-05f,  1.672013802285499e-05f,
    1.401822771499189e-05f,   1.116314099328452e-05f,   8.174494434889556e-06f,
    5.073777874807885e-06f,   1.8842662597457689e-06f,  -1.3691952586636756e-06f,
    -4.6603229792228e-06f,    -7.96165095584204e-06f,   -1.1244701583619294e-05f,
    -1.448027774449545e-05f,  -1.7638665827907684e-05f, -2.0689956316023554e-05f,
    -2.360427097884015e-05f,  -2.6352102838158265e-05f, -2.8904557754131346e-05f,
    -3.123370332922038e-05f,  -3.3312813885959586e-05f, -3.511671684644037e-05f,
    -3.662202927629706e-05f,  -3.780748965780989e-05f,  -3.865417378974254e-05f,
    -3.9145799728825364e-05f, -3.926891093071025e-05f,  -3.901314248422075e-05f,
    -3.837135999044647e-05f,  -3.7339876077184325e-05f, -3.5918534630140354e-05f,
    -3.4110867949888845e-05f, -3.192411756470153e-05f,  -2.9369324238122838e-05f,
    -2.6461278666878536e-05f, -2.321853882709392e-05f,  -1.9663306324117362e-05f,
    -1.582136820211788e-05f,  -1.1721897498015446e-05f, -7.397319540636834e-06f,
    -2.8830382597476033e-06f, 1.7827699286994674e-06f,  6.559499404242755e-06f,
    1.1404387664529182e-05f,  1.627292045358548e-05f,   2.1119161056349855e-05f,
    2.5896206591699535e-05f,  3.055656222198768e-05f,   3.5052635262969936e-05f,
    3.933713977452334e-05f,   4.336361287409911e-05f,   4.7086833152110287e-05f,
    5.0463341828252825e-05f,  5.345185698163129e-05f,   5.601378105121461e-05f,
    5.811359207471672e-05f,   5.971931859326725e-05f,   6.080288901670427e-05f,
    6.134055529759193e-05f,   6.131318223246775e-05f,   6.070660234657664e-05f,
    5.95118284051857e-05f,    5.772532379948405e-05f,   5.534912376086182e-05f,
    5.23910081168302e-05f,    4.886451962522501e-05f,   4.4789029212681096e-05f,
    4.018964338478892e-05f,   3.509715587003459e-05f,   2.9547840108151414e-05f,
    2.3583285467971155e-05f,  1.725007522757156e-05f,   1.0599510069417e-05f,
    3.6871765789571587e-06f,  -3.4274346296102827e-06f, -1.0681460228395685e-05f,
    -1.8009139483843417e-05f, -2.5342431240009755e-05f, -3.2611566397552296e-05f,
    -3.974573229314049e-05f,  -4.667368220628645e-05f,  -5.3324465271149075e-05f,
    -5.962806961035961e-05f,  -6.55161730329145e-05f,   -7.092279392168379e-05f,
    -7.57850359448219e-05f,   -8.004371927556629e-05f,  -8.364409149899293e-05f,
    -8.653641122231216e-05f,  -8.867659738259816e-05f,  -9.002673788455754e-05f,
    -9.055565065515076e-05f,  -9.023929165068529e-05f,  -8.906120326880979e-05f,
    -8.701279888033797e-05f,  -8.409367755697649e-05f,  -8.031176614418611e-05f,
    -7.56834836090114e-05f,   -7.023372646939491e-05f,  -6.399587128142852e-05f,
    -5.7011594827574566e-05f, -4.93307091746267e-05f,   -4.101081420907435e-05f,
    -3.211696610007688e-05f,  -2.272116633161569e-05f,  -1.2901871063143494e-05f,
    -2.743327498524621e-06f,  7.665061706161077e-06f,   1.8229537340853627e-05f,
    2.8852743649604e-05f,     3.943463894765634e-05f,   4.987335365828177e-05f,
    6.006618361733238e-05f,   6.991051469744174e-05f,   7.930486520310004e-05f,
    8.814984162050622e-05f,   9.634919308195098e-05f,   0.00010381075999810917f,
    0.00011044750147400087f,  0.00011617839720380285f,  0.0001209294080921499f,
    0.00012463429193422984f,  0.00012723545842486286f,  0.00012868466086749785f,
    0.00012894370926694543f,  0.00012798500360898478f,  0.00012579207279785212f,
    0.00012235991985644248f,  0.00011769535998961054f,  0.00011181715424578783f,
    0.00010475612680083863f,  9.655507100496837e-05f,   8.726863387238253e-05f,
    7.696298676664666e-05f,   6.57154737771502e-05f,    5.3614048279534124e-05f,
    4.075669106690973e-05f,   2.725062332657949e-05f,   1.321150972707929e-05f,
    -1.2375323793047458e-06f, -1.5966920601378708e-05f, -3.084177340923091e-05f,
    -4.57230556801464e-05f,   -6.046888294588057e-05f,  -7.49357844460623e-05f,
    -8.898010201188567e-05f,  -0.00010245932396748079f, -0.00011523352943641821f,
    -0.00012716674176136106f, -0.00013812836524621888f, -0.0001479945039409905f,
    -0.00015664933600521272f, -0.00016398634291304258f, -0.00016990956689417886f,
    -0.00017433469696435255f, -0.00017719015733865133f, -0.00017841800021677927f,
    -0.00017797477765830967f, -0.00017583219669350413f, -0.00017197773380332916f,
    -0.00016641501554407856f, -0.00015916414330082774f, -0.0001502617719825675f,
    -0.00013976112285116885f, -0.00012773174365719728f, -0.00011425919874758687f,
    -9.944450589891458e-05f,  -8.3403505170897e-05f,    -6.626598022290954e-05f,
    -4.817472005591594e-05f,  -2.928434529684638e-05f,  -9.760089570672502e-06f,
    1.0223636388809366e-05f,  3.0484704973611817e-05f,  5.083492536065616e-05f,
    7.108169564266037e-05f,   9.102981962371014e-05f,   0.00011048329173741639f,
    0.000129247213884939f,    0.0001471296466095719f,   0.00016394355659253722f,
    0.0001795086624751624f,   0.00019365333983465533f,  0.0002062163875981821f,
    0.0002170488162678216f,   0.000226015461247329f,    0.00023299658191446024f,
    0.00023788925147031736f,  0.00024060869920032764f,  0.00024108941263361404f,
    0.00023928616291071897f,  0.00023517476396696493f,  0.00022875273113855376f,
    0.0002200396535072998f,   0.00020907744841915682f,  0.00019593031668663257f,
    0.00018068457015485862f,  0.00016344815469480586f,  0.00014435004382951558f,
    0.0001235393308258238f,   0.00010118419811296474f,  7.747059668758022e-05f,
    5.2600817989956834e-05f,  2.679179563072751e-05f,   2.733228772450164e-07f,
    -2.671397227497538e-05f,  -5.392070547571852e-05f,  -8.109102200211033e-05f,
    -0.00010796489883834304f, -0.0001342806135902838f,  -0.0001597771868446994f,
    -0.000184196945999854f,   -0.00020728801607958894f, -0.0002288068836710535f,
    -0.00024852083927584995f, -0.00026621044323087357f, -0.00028167182120452945f,
    -0.00029471893438883174f, -0.0003051856320751093f,  -0.0003129276326564301f,
    -0.00031782424338357173f, -0.00031977996677061177f, -0.00031872580752679186f,
    -0.00031462043062852697f, -0.0003074509887845718f,  -0.00029723377338946645f,
    -0.00028401451230186274f, -0.0002678684726518486f,  -0.000248900197654658f,
    -0.00022724304020653338f, -0.00020305832826024878f, -0.00017653432960251938f,
    -0.0001478848572320047f,  -0.0001173476878751702f,  -8.51826410097984e-05f,
    -5.1669495701871284e-05f, -1.7105598548771798e-05f, 1.819665556029199e-05f,
    5.391261111238178e-05f,   8.970822252529665e-05f,   0.00012524314403792604f,
    0.0001601738503305641f,   0.00019415692037796735f,  0.0002268522938039298f,
    0.00025792662929824796f,  0.0002870565733181992f,   0.0003139320668203912f,
    0.0003382594983788119f,   0.00035976483082794165f,  0.00037819651116086865f,
    0.00039332829145863525f,  0.00040496177320753507f,  0.00041292880465201517f,
    0.0004170935473836665f,   0.00041735434485877293f,  0.00041364521402231655f,
    0.0004059370968412526f,   0.0003942386989043231f,   0.000378597056914529f,
    0.0003590976690388837f,   0.00033586433568353393f,  0.00030905855208246917f,
    0.00027887860650091544f,  0.0002455582332384727f,   0.0002093649807023856f,
    0.0001705981516423861f,   0.0001295864822504828f,   8.66854249558109e-05f,
    4.2274207736236086e-05f,  -3.2474579314239593e-06f, -4.946284213358156e-05f,
    -9.594195589712438e-05f,  -0.00014224542185788125f, -0.0001879285719147388f,
    -0.00023254558525927758f, -0.00027565377805432165f, -0.0003168178558555786f,
    -0.0003556142369965464f,  -0.0003916352571829917f,  -0.0004244933619648919f,
    -0.00045382509803855594f, -0.00047929501007340166f, -0.0005005992563259812f,
    -0.0005174690513607145f,  -0.0005296737530413969f,  -0.0005370237052936359f,
    -0.0005393726592220602f,  -0.0005366198887140057f,  -0.0005287118299168158f,
    -0.0005156433666390746f,  -0.0004974585990566555f,  -0.00047425122476033125f,
    -0.00044616437846603003f, -0.00041339006721086f,    -0.00037616805695384173f,
    -0.0003347843556844935f,  -0.0002895691588912755f,  -0.00024089441093081565f,
    -0.00018917085807337763f, -0.00013484475500969795f, -7.839411015324618e-05f,
    -2.032463921877408e-05f,  3.8834678745971985e-05f,  9.85362665915278e-05f,
    0.00015821893359121265f,  0.00021731299738448926f,  0.00027524563492941425f,
    0.0003314462764947297f,   0.00038535212945389156f,  0.0004364136435453752f,
    0.0004841000013502528f,   0.0005279044451873575f,   0.0005673495231227897f,
    0.0006019920668372276f,   0.0006314279850190686f,   0.000655296688607947f,
    0.0006732852345456945f,   0.0006851320099310334f,   0.0006906300481557227f,
    0.0006896298063558588f,   0.0006820415024445853f,   0.0006678368501622721f,
    0.0006470502986303706f,   0.0006197796253413883f,   0.0005861859985197228f,
    0.0005464933693440669f,   0.0005009873202841571f,   0.0004500132422796951f,
    0.0003939739777988133f,   0.00033332681499992773f,  0.00026857998085234424f,
    0.00020028853075260857f,  0.00012904979289657682f,  5.549827662654711e-05f,
    -1.9699787439122383e-05f, -9.585235565880687e-05f,  -0.00017224775192952368f,
    -0.00024816119158109284f, -0.00032286146593126603f, -0.0003956178512202061f,
    -0.0004657070546570574f,  -0.0005324202561306667f,  -0.0005950700559901425f,
    -0.0006529973846484274f,  -0.0007055781845433626f,  -0.0007522299199215308f,
    -0.0007924177276631846f,  -0.0008256602668880504f,  -0.0008515350858021753f,
    -0.0008696835683175794f,  -0.0008798152866102134f,  -0.0008817118293137541f,
    -0.0008752299414923086f,  -0.0008603040553909621f,  -0.0008369480600725488f,
    -0.0008052564000495606f,  -0.0007654043646053918f,  -0.0007176476704259646f,
    -0.0006623212140017579f,  -0.000599837109865414f,   -0.0005306819065726744f,
    -0.0004554131103474486f,  -0.00037465492389131483f, -0.00028909334399467474f,
    -0.0001994705406285491f,  -0.00010657867417098466f, -1.1253087653746344e-05f,
    8.56349575499892e-05f,    0.00018318605301307804f,  0.0002804807430971262f,
    0.00037658799307138424f,  0.00047057383932172145f,  0.0005615102531091633f,
    0.0006484840265521114f,   0.0007306057068153733f,   0.0008070183849703284f,
    0.0008769063630728758f,   0.0009395035068455165f,   0.0009941013082588727f,
    0.0010400564695411166f,   0.0010767980368734116f,   0.001103833902630168f,
    0.001120756711506384f,    0.0011272489997559243f,   0.001123087612874878f,
    0.001108147244080535f,    0.0010824031514894978f,   0.0010459329118487556f,
    0.0009989172834329665f,   0.000941640053355709f,    0.0008744869582276804f,
    0.0007979435721233552f,   0.0007125922681124888f,   0.0006191081667152786f,
    0.0005182541952032905f,   0.00041087519050589307f,  0.0002978911869603347f,
    0.00018028984037055137f,  5.9118145880518086e-05f,  -6.452658155414232e-05f,
    -0.00018950629204987147f, -0.0003146523669774377f,  -0.00043877618221442247f,
    -0.0005606800717830937f,  -0.000679168498383472f,   -0.0007930594246698564f,
    -0.0009011956859048674f,  -0.0010024563519457446f,  -0.0010957678770593439f,
    -0.0011801150234886505f,  -0.0012545513590895166f,  -0.0013182093169416828f,
    -0.0013703096231137543f,  -0.0014101700864856343f,  -0.0014372135666377666f,
    -0.0014509751235826124f,  -0.0014511081789255532f,  -0.0014373897056804683f,
    -0.0014097242932861929f,  -0.0013681471216404864f,  -0.0013128257105343981f,
    -0.0012440604974705487f,  -0.001162284132338562f,   -0.0010680595629954147f,
    -0.0009620768238424806f,  -0.0008451486236418673f,  -0.0007182046690080504f,
    -0.0005822848423126619f,  -0.0004385311946573797f,  -0.00028817889458423594f,
    -0.00013254611640226225f, 2.697697069919471e-05f,   0.0001889401074988343f,
    0.00035184556415024956f,  0.0005141614501846263f,   0.0006743355205179473f,
    0.0008308094381848999f,   0.0009820332877493103f,   0.0011264802888228476f,
    0.0012626614964773935f,   0.0013891404312139446f,   0.0015045474228260174f,
    0.0016075936089161005f,   0.0016970843749329698f,   0.0017719321796217983f,
    0.0018311685603455846f,   0.0018739552703338413f,   0.0018995943548686602f,
    0.0019075371314658742f,   0.0018973918982894524f,   0.001868930353321279f,
    0.0018220925699649485f,   0.0017569905329841038f,   0.0016739101054768183f,
    0.0015733114553718509f,   0.0014558278399758567f,   0.0013222628040069112f,
    0.001173585719374682f,    0.0010109257505048132f,   0.0008355642041090058f,
    0.0006489253759450325f,   0.00045256588396546337f,  0.0002481626284614968f,
    3.749939787797375e-05f,   -0.00017754771278923837f, -0.000395026025339826f,
    -0.0006129229530385477f,  -0.0008291835572213368f,  -0.001041728775665465f,
    -0.0012484742338223415f,  -0.001447349413600483f,   -0.001636317076264964f,
    -0.0018133927043211735f,  -0.0019766638500259043f,  -0.002124309151430826f,
    -0.0022546169007272437f,  -0.002366002928031162f,   -0.0024570276887879838f,
    -0.002526412326493027f,   -0.0025730536086184088f,  -0.002596037522226976f,
    -0.0025946514429669824f,  -0.002568394684619728f,   -0.0025169873643582433f,
    -0.0024403774169489164f,  -0.0023387457195366895f,  -0.0022125091909307743f,
    -0.002062321857695429f,   -0.0018890737853478508f,  -0.0016938879008071834f,
    -0.0014781146414035752f,  -0.001243324492463428f,   -0.000991298387211193f,
    -0.0007240160676669854f,  -0.00044364241885974204f, -0.00015251191118984496f,
    0.0001468887993234891f,   0.0004519399437428266f,   0.0007599093011757708f,
    0.001067974247601496f,    0.0013732450766369346f,   0.0016727893649132021f,
    0.0019636572397572346f,   0.0022429073003000814f,   0.0025076330291847328f,
    0.0027549894307422177f,   0.0029822197189669415f,   0.003186681782922042f,
    0.0033658742463512975f,   0.0035174618483955747f,   0.0036392999632922475f,
    0.0037294579929700337f,   0.0037862414592875144f,   0.0038082125445695197f,
    0.0037942089236745464f,   0.0037433606584294146f,   0.003655105021345824f,
    0.0035291990485296605f,   0.0033657297189015603f,   0.0031651215948113043f,
    0.0029281418569796634f,   0.0026559026090989483f,   0.0023498604253312664f,
    0.002011813060148105f,    0.0016438933372494077f,   0.001248560183612937f,
    0.0008285868706759194f,   0.00038704647632227816f,  -7.27053248115262e-05f,
    -0.0005470500819420872f,  -0.0010321288479369856f,  -0.0015238668125170266f,
    -0.0020180000957801068f,  -0.0025101045548269274f,  -0.0029956263733541544f,
    -0.0034699142505648715f,  -0.003928252927869182f,   -0.004365897839567386f,
    -0.00477811060143595f,    -0.005160195100604596f,   -0.0055075338839038115f,
    -0.005815624593471737f,   -0.0060801161385959385f,  -0.006296844346776425f,
    -0.0064618667837688815f,  -0.006571496488894907f,   -0.006622334325308373f,
    -0.0066112997039163126f,  -0.006535659399575724f,   -0.0063930542394926805f,
    -0.006181523409935861f,   -0.005899526190643588f,   -0.00554596089835116f,
    -0.005120180885623808f,   -0.0046220074185577414f,  -0.0040517393225683205f,
    -0.0034101592675451113f,  -0.002698536629508342f,   -0.001918626851905458f,
    -0.0010726672949592417f,  -0.0001633695506137992f,  0.0008060917355210808f,
    0.00183209350241646f,     0.0029105822776842386f,   0.004037095460256808f,
    0.0052067857360846535f,   0.006414448487883024f,    0.007654552005550349f,
    0.008921270310783812f,    0.01020851835979069f,     0.011509989395909127f,
    0.01281919417981835f,     0.014129501834594684f,    0.01543418200482047f,
    0.016726448040733567f,    0.017999500886908104f,    0.01924657336933741f,
    0.020460974550179287f,    0.021636133836650154f,    0.02276564451300025f,
    0.02384330638467331f,     0.02486316721326242f,     0.0258195626439173f,
    0.026707154323288164f,    0.027520965931766048f,    0.028256416856823084f,
    0.028909353262187687f,    0.029476076316776796f,    0.029953367376976677f,
    0.030338509930607396f,    0.030629308141648964f,    0.030824101854417307f,
    0.030921777946938955f,    0.030921777946938955f,    0.030824101854417307f,
    0.030629308141648964f,    0.030338509930607396f,    0.029953367376976677f,
    0.029476076316776796f,    0.028909353262187687f,    0.028256416856823084f,
    0.027520965931766048f,    0.026707154323288164f,    0.0258195626439173f,
    0.02486316721326242f,     0.02384330638467331f,     0.02276564451300025f,
    0.021636133836650154f,    0.020460974550179287f,    0.01924657336933741f,
    0.017999500886908104f,    0.016726448040733567f,    0.01543418200482047f,
    0.014129501834594684f,    0.01281919417981835f,     0.011509989395909127f,
    0.01020851835979069f,     0.008921270310783812f,    0.007654552005550349f,
    0.006414448487883024f,    0.0052067857360846535f,   0.004037095460256808f,
    0.0029105822776842386f,   0.00183209350241646f,     0.0008060917355210808f,
    -0.0001633695506137992f,  -0.0010726672949592417f,  -0.001918626851905458f,
    -0.002698536629508342f,   -0.0034101592675451113f,  -0.0040517393225683205f,
    -0.0046220074185577414f,  -0.005120180885623808f,   -0.00554596089835116f,
    -0.005899526190643588f,   -0.006181523409935861f,   -0.0063930542394926805f,
    -0.006535659399575724f,   -0.0066112997039163126f,  -0.006622334325308373f,
    -0.006571496488894907f,   -0.0064618667837688815f,  -0.006296844346776425f,
    -0.0060801161385959385f,  -0.005815624593471737f,   -0.0055075338839038115f,
    -0.005160195100604596f,   -0.00477811060143595f,    -0.004365897839567386f,
    -0.003928252927869182f,   -0.0034699142505648715f,  -0.0029956263733541544f,
    -0.0025101045548269274f,  -0.0020180000957801068f,  -0.0015238668125170266f,
    -0.0010321288479369856f,  -0.0005470500819420872f,  -7.27053248115262e-05f,
    0.00038704647632227816f,  0.0008285868706759194f,   0.001248560183612937f,
    0.0016438933372494077f,   0.002011813060148105f,    0.0023498604253312664f,
    0.0026559026090989483f,   0.0029281418569796634f,   0.0031651215948113043f,
    0.0033657297189015603f,   0.0035291990485296605f,   0.003655105021345824f,
    0.0037433606584294146f,   0.0037942089236745464f,   0.0038082125445695197f,
    0.0037862414592875144f,   0.0037294579929700337f,   0.0036392999632922475f,
    0.0035174618483955747f,   0.0033658742463512975f,   0.003186681782922042f,
    0.0029822197189669415f,   0.0027549894307422177f,   0.0025076330291847328f,
    0.0022429073003000814f,   0.0019636572397572346f,   0.0016727893649132021f,
    0.0013732450766369346f,   0.001067974247601496f,    0.0007599093011757708f,
    0.0004519399437428266f,   0.0001468887993234891f,   -0.00015251191118984496f,
    -0.00044364241885974204f, -0.0007240160676669854f,  -0.000991298387211193f,
    -0.001243324492463428f,   -0.0014781146414035752f,  -0.0016938879008071834f,
    -0.0018890737853478508f,  -0.002062321857695429f,   -0.0022125091909307743f,
    -0.0023387457195366895f,  -0.0024403774169489164f,  -0.0025169873643582433f,
    -0.002568394684619728f,   -0.0025946514429669824f,  -0.002596037522226976f,
    -0.0025730536086184088f,  -0.002526412326493027f,   -0.0024570276887879838f,
    -0.002366002928031162f,   -0.0022546169007272437f,  -0.002124309151430826f,
    -0.0019766638500259043f,  -0.0018133927043211735f,  -0.001636317076264964f,
    -0.001447349413600483f,   -0.0012484742338223415f,  -0.001041728775665465f,
    -0.0008291835572213368f,  -0.0006129229530385477f,  -0.000395026025339826f,
    -0.00017754771278923837f, 3.749939787797375e-05f,   0.0002481626284614968f,
    0.00045256588396546337f,  0.0006489253759450325f,   0.0008355642041090058f,
    0.0010109257505048132f,   0.001173585719374682f,    0.0013222628040069112f,
    0.0014558278399758567f,   0.0015733114553718509f,   0.0016739101054768183f,
    0.0017569905329841038f,   0.0018220925699649485f,   0.001868930353321279f,
    0.0018973918982894524f,   0.0019075371314658742f,   0.0018995943548686602f,
    0.0018739552703338413f,   0.0018311685603455846f,   0.0017719321796217983f,
    0.0016970843749329698f,   0.0016075936089161005f,   0.0015045474228260174f,
    0.0013891404312139446f,   0.0012626614964773935f,   0.0011264802888228476f,
    0.0009820332877493103f,   0.0008308094381848999f,   0.0006743355205179473f,
    0.0005141614501846263f,   0.00035184556415024956f,  0.0001889401074988343f,
    2.697697069919471e-05f,   -0.00013254611640226225f, -0.00028817889458423594f,
    -0.0004385311946573797f,  -0.0005822848423126619f,  -0.0007182046690080504f,
    -0.0008451486236418673f,  -0.0009620768238424806f,  -0.0010680595629954147f,
    -0.001162284132338562f,   -0.0012440604974705487f,  -0.0013128257105343981f,
    -0.0013681471216404864f,  -0.0014097242932861929f,  -0.0014373897056804683f,
    -0.0014511081789255532f,  -0.0014509751235826124f,  -0.0014372135666377666f,
    -0.0014101700864856343f,  -0.0013703096231137543f,  -0.0013182093169416828f,
    -0.0012545513590895166f,  -0.0011801150234886505f,  -0.0010957678770593439f,
    -0.0010024563519457446f,  -0.0009011956859048674f,  -0.0007930594246698564f,
    -0.000679168498383472f,   -0.0005606800717830937f,  -0.00043877618221442247f,
    -0.0003146523669774377f,  -0.00018950629204987147f, -6.452658155414232e-05f,
    5.9118145880518086e-05f,  0.00018028984037055137f,  0.0002978911869603347f,
    0.00041087519050589307f,  0.0005182541952032905f,   0.0006191081667152786f,
    0.0007125922681124888f,   0.0007979435721233552f,   0.0008744869582276804f,
    0.000941640053355709f,    0.0009989172834329665f,   0.0010459329118487556f,
    0.0010824031514894978f,   0.001108147244080535f,    0.001123087612874878f,
    0.0011272489997559243f,   0.001120756711506384f,    0.001103833902630168f,
    0.0010767980368734116f,   0.0010400564695411166f,   0.0009941013082588727f,
    0.0009395035068455165f,   0.0008769063630728758f,   0.0008070183849703284f,
    0.0007306057068153733f,   0.0006484840265521114f,   0.0005615102531091633f,
    0.00047057383932172145f,  0.00037658799307138424f,  0.0002804807430971262f,
    0.00018318605301307804f,  8.56349575499892e-05f,    -1.1253087653746344e-05f,
    -0.00010657867417098466f, -0.0001994705406285491f,  -0.00028909334399467474f,
    -0.00037465492389131483f, -0.0004554131103474486f,  -0.0005306819065726744f,
    -0.000599837109865414f,   -0.0006623212140017579f,  -0.0007176476704259646f,
    -0.0007654043646053918f,  -0.0008052564000495606f,  -0.0008369480600725488f,
    -0.0008603040553909621f,  -0.0008752299414923086f,  -0.0008817118293137541f,
    -0.0008798152866102134f,  -0.0008696835683175794f,  -0.0008515350858021753f,
    -0.0008256602668880504f,  -0.0007924177276631846f,  -0.0007522299199215308f,
    -0.0007055781845433626f,  -0.0006529973846484274f,  -0.0005950700559901425f,
    -0.0005324202561306667f,  -0.0004657070546570574f,  -0.0003956178512202061f,
    -0.00032286146593126603f, -0.00024816119158109284f, -0.00017224775192952368f,
    -9.585235565880687e-05f,  -1.9699787439122383e-05f, 5.549827662654711e-05f,
    0.00012904979289657682f,  0.00020028853075260857f,  0.00026857998085234424f,
    0.00033332681499992773f,  0.0003939739777988133f,   0.0004500132422796951f,
    0.0005009873202841571f,   0.0005464933693440669f,   0.0005861859985197228f,
    0.0006197796253413883f,   0.0006470502986303706f,   0.0006678368501622721f,
    0.0006820415024445853f,   0.0006896298063558588f,   0.0006906300481557227f,
    0.0006851320099310334f,   0.0006732852345456945f,   0.000655296688607947f,
    0.0006314279850190686f,   0.0006019920668372276f,   0.0005673495231227897f,
    0.0005279044451873575f,   0.0004841000013502528f,   0.0004364136435453752f,
    0.00038535212945389156f,  0.0003314462764947297f,   0.00027524563492941425f,
    0.00021731299738448926f,  0.00015821893359121265f,  9.85362665915278e-05f,
    3.8834678745971985e-05f,  -2.032463921877408e-05f,  -7.839411015324618e-05f,
    -0.00013484475500969795f, -0.00018917085807337763f, -0.00024089441093081565f,
    -0.0002895691588912755f,  -0.0003347843556844935f,  -0.00037616805695384173f,
    -0.00041339006721086f,    -0.00044616437846603003f, -0.00047425122476033125f,
    -0.0004974585990566555f,  -0.0005156433666390746f,  -0.0005287118299168158f,
    -0.0005366198887140057f,  -0.0005393726592220602f,  -0.0005370237052936359f,
    -0.0005296737530413969f,  -0.0005174690513607145f,  -0.0005005992563259812f,
    -0.00047929501007340166f, -0.00045382509803855594f, -0.0004244933619648919f,
    -0.0003916352571829917f,  -0.0003556142369965464f,  -0.0003168178558555786f,
    -0.00027565377805432165f, -0.00023254558525927758f, -0.0001879285719147388f,
    -0.00014224542185788125f, -9.594195589712438e-05f,  -4.946284213358156e-05f,
    -3.2474579314239593e-06f, 4.2274207736236086e-05f,  8.66854249558109e-05f,
    0.0001295864822504828f,   0.0001705981516423861f,   0.0002093649807023856f,
    0.0002455582332384727f,   0.00027887860650091544f,  0.00030905855208246917f,
    0.00033586433568353393f,  0.0003590976690388837f,   0.000378597056914529f,
    0.0003942386989043231f,   0.0004059370968412526f,   0.00041364521402231655f,
    0.00041735434485877293f,  0.0004170935473836665f,   0.00041292880465201517f,
    0.00040496177320753507f,  0.00039332829145863525f,  0.00037819651116086865f,
    0.00035976483082794165f,  0.0003382594983788119f,   0.0003139320668203912f,
    0.0002870565733181992f,   0.00025792662929824796f,  0.0002268522938039298f,
    0.00019415692037796735f,  0.0001601738503305641f,   0.00012524314403792604f,
    8.970822252529665e-05f,   5.391261111238178e-05f,   1.819665556029199e-05f,
    -1.7105598548771798e-05f, -5.1669495701871284e-05f, -8.51826410097984e-05f,
    -0.0001173476878751702f,  -0.0001478848572320047f,  -0.00017653432960251938f,
    -0.00020305832826024878f, -0.00022724304020653338f, -0.000248900197654658f,
    -0.0002678684726518486f,  -0.00028401451230186274f, -0.00029723377338946645f,
    -0.0003074509887845718f,  -0.00031462043062852697f, -0.00031872580752679186f,
    -0.00031977996677061177f, -0.00031782424338357173f, -0.0003129276326564301f,
    -0.0003051856320751093f,  -0.00029471893438883174f, -0.00028167182120452945f,
    -0.00026621044323087357f, -0.00024852083927584995f, -0.0002288068836710535f,
    -0.00020728801607958894f, -0.000184196945999854f,   -0.0001597771868446994f,
    -0.0001342806135902838f,  -0.00010796489883834304f, -8.109102200211033e-05f,
    -5.392070547571852e-05f,  -2.671397227497538e-05f,  2.733228772450164e-07f,
    2.679179563072751e-05f,   5.2600817989956834e-05f,  7.747059668758022e-05f,
    0.00010118419811296474f,  0.0001235393308258238f,   0.00014435004382951558f,
    0.00016344815469480586f,  0.00018068457015485862f,  0.00019593031668663257f,
    0.00020907744841915682f,  0.0002200396535072998f,   0.00022875273113855376f,
    0.00023517476396696493f,  0.00023928616291071897f,  0.00024108941263361404f,
    0.00024060869920032764f,  0.00023788925147031736f,  0.00023299658191446024f,
    0.000226015461247329f,    0.0002170488162678216f,   0.0002062163875981821f,
    0.00019365333983465533f,  0.0001795086624751624f,   0.00016394355659253722f,
    0.0001471296466095719f,   0.000129247213884939f,    0.00011048329173741639f,
    9.102981962371014e-05f,   7.108169564266037e-05f,   5.083492536065616e-05f,
    3.0484704973611817e-05f,  1.0223636388809366e-05f,  -9.760089570672502e-06f,
    -2.928434529684638e-05f,  -4.817472005591594e-05f,  -6.626598022290954e-05f,
    -8.3403505170897e-05f,    -9.944450589891458e-05f,  -0.00011425919874758687f,
    -0.00012773174365719728f, -0.00013976112285116885f, -0.0001502617719825675f,
    -0.00015916414330082774f, -0.00016641501554407856f, -0.00017197773380332916f,
    -0.00017583219669350413f, -0.00017797477765830967f, -0.00017841800021677927f,
    -0.00017719015733865133f, -0.00017433469696435255f, -0.00016990956689417886f,
    -0.00016398634291304258f, -0.00015664933600521272f, -0.0001479945039409905f,
    -0.00013812836524621888f, -0.00012716674176136106f, -0.00011523352943641821f,
    -0.00010245932396748079f, -8.898010201188567e-05f,  -7.49357844460623e-05f,
    -6.046888294588057e-05f,  -4.57230556801464e-05f,   -3.084177340923091e-05f,
    -1.5966920601378708e-05f, -1.2375323793047458e-06f, 1.321150972707929e-05f,
    2.725062332657949e-05f,   4.075669106690973e-05f,   5.3614048279534124e-05f,
    6.57154737771502e-05f,    7.696298676664666e-05f,   8.726863387238253e-05f,
    9.655507100496837e-05f,   0.00010475612680083863f,  0.00011181715424578783f,
    0.00011769535998961054f,  0.00012235991985644248f,  0.00012579207279785212f,
    0.00012798500360898478f,  0.00012894370926694543f,  0.00012868466086749785f,
    0.00012723545842486286f,  0.00012463429193422984f,  0.0001209294080921499f,
    0.00011617839720380285f,  0.00011044750147400087f,  0.00010381075999810917f,
    9.634919308195098e-05f,   8.814984162050622e-05f,   7.930486520310004e-05f,
    6.991051469744174e-05f,   6.006618361733238e-05f,   4.987335365828177e-05f,
    3.943463894765634e-05f,   2.8852743649604e-05f,     1.8229537340853627e-05f,
    7.665061706161077e-06f,   -2.743327498524621e-06f,  -1.2901871063143494e-05f,
    -2.272116633161569e-05f,  -3.211696610007688e-05f,  -4.101081420907435e-05f,
    -4.93307091746267e-05f,   -5.7011594827574566e-05f, -6.399587128142852e-05f,
    -7.023372646939491e-05f,  -7.56834836090114e-05f,   -8.031176614418611e-05f,
    -8.409367755697649e-05f,  -8.701279888033797e-05f,  -8.906120326880979e-05f,
    -9.023929165068529e-05f,  -9.055565065515076e-05f,  -9.002673788455754e-05f,
    -8.867659738259816e-05f,  -8.653641122231216e-05f,  -8.364409149899293e-05f,
    -8.004371927556629e-05f,  -7.57850359448219e-05f,   -7.092279392168379e-05f,
    -6.55161730329145e-05f,   -5.962806961035961e-05f,  -5.3324465271149075e-05f,
    -4.667368220628645e-05f,  -3.974573229314049e-05f,  -3.2611566397552296e-05f,
    -2.5342431240009755e-05f, -1.8009139483843417e-05f, -1.0681460228395685e-05f,
    -3.4274346296102827e-06f, 3.6871765789571587e-06f,  1.0599510069417e-05f,
    1.725007522757156e-05f,   2.3583285467971155e-05f,  2.9547840108151414e-05f,
    3.509715587003459e-05f,   4.018964338478892e-05f,   4.4789029212681096e-05f,
    4.886451962522501e-05f,   5.23910081168302e-05f,    5.534912376086182e-05f,
    5.772532379948405e-05f,   5.95118284051857e-05f,    6.070660234657664e-05f,
    6.131318223246775e-05f,   6.134055529759193e-05f,   6.080288901670427e-05f,
    5.971931859326725e-05f,   5.811359207471672e-05f,   5.601378105121461e-05f,
    5.345185698163129e-05f,   5.0463341828252825e-05f,  4.7086833152110287e-05f,
    4.336361287409911e-05f,   3.933713977452334e-05f,   3.5052635262969936e-05f,
    3.055656222198768e-05f,   2.5896206591699535e-05f,  2.1119161056349855e-05f,
    1.627292045358548e-05f,   1.1404387664529182e-05f,  6.559499404242755e-06f,
    1.7827699286994674e-06f,  -2.8830382597476033e-06f, -7.397319540636834e-06f,
    -1.1721897498015446e-05f, -1.582136820211788e-05f,  -1.9663306324117362e-05f,
    -2.321853882709392e-05f,  -2.6461278666878536e-05f, -2.9369324238122838e-05f,
    -3.192411756470153e-05f,  -3.4110867949888845e-05f, -3.5918534630140354e-05f,
    -3.7339876077184325e-05f, -3.837135999044647e-05f,  -3.901314248422075e-05f,
    -3.926891093071025e-05f,  -3.9145799728825364e-05f, -3.865417378974254e-05f,
    -3.780748965780989e-05f,  -3.662202927629706e-05f,  -3.511671684644037e-05f,
    -3.3312813885959586e-05f, -3.123370332922038e-05f,  -2.8904557754131346e-05f,
    -2.6352102838158265e-05f, -2.360427097884015e-05f,  -2.0689956316023554e-05f,
    -1.7638665827907684e-05f, -1.448027774449545e-05f,  -1.1244701583619294e-05f,
    -7.96165095584204e-06f,   -4.6603229792228e-06f,    -1.3691952586636756e-06f,
    1.8842662597457689e-06f,  5.073777874807885e-06f,   8.174494434889556e-06f,
    1.116314099328452e-05f,   1.401822771499189e-05f,   1.672013802285499e-05f,
    1.9251298511794225e-05f,  2.159622098374245e-05f,   2.3741625758696218e-05f,
    2.5676436966620375e-05f,  2.7391859567928292e-05f,  2.8881329139335317e-05f,
    3.0140544718886587e-05f,  3.1167376027591566e-05f,  3.1961855851965694e-05f,
    3.252604913234915e-05f,   3.286400995058404e-05f,   3.298161812479974e-05f,
    3.288650694016886e-05f,   3.258787380513695e-05f,   3.209638561052228e-05f,
    3.1423970595074046e-05f,  3.058370865174652e-05f,   2.9589611811669155e-05f,
    2.8456506921749016e-05f,  2.7199812112700867e-05f,  2.58354190690499e-05f,
    2.4379472499427122e-05f,  2.284825874712199e-05f,   2.125799467540191e-05f,
    1.9624728639943934e-05f,  1.7964144381562335e-05f,  1.6291479466825486e-05f,
    1.462134877651063e-05f,   1.296768445907276e-05f,   1.134358249120489e-05f,
    9.761267025727237e-06f,   8.231962317204055e-06f,   6.765883156649178e-06f,
    5.372133255689227e-06f,   4.058722274925803e-06f,   2.8324906099084146e-06f,
    1.699152398532655e-06f,   6.632455737403016e-07f,   -2.718007740031418e-07f,
    -1.1036931596126e-06f,    -1.8311844907647367e-06f, -2.454080518541603e-06f,
    -2.9731319810317487e-06f, -3.3900242344043525e-06f, -3.707254477608423e-06f,
    -3.928108471024311e-06f,  -4.056526894188398e-06f,  -4.097073284186477e-06f,
    -4.054793696533239e-06f,  -5.134510021745512e-05f
};

int main(int argc, char** argv)
{
    using namespace boost::ut;
    using c64 = std::complex<float>;

    expect(fatal(eq(argc, 4)));
    const double esn0_db = std::stod(argv[1]);
    const float freq_error = std::stof(argv[2]);
    const float sfo_ppm = std::stof(argv[3]);

    const double tx_power = 0.32; // measured from packet_transmitter_pdu output
    const size_t samples_per_symbol = 4U;
    const double n0 = tx_power * static_cast<double>(samples_per_symbol) *
                      std::pow(10.0, -0.1 * esn0_db);
    const float noise_amplitude = static_cast<float>(std::sqrt(n0));

    const double samp_rate = 1e6;

    gr::Graph fg;
    auto& source = fg.emplaceBlock<gr::packet_modem::TunSource>(
        { { "tun_name", "gr4_tun_tx" }, { "netns_name", "gr4_tx" } });
    const bool stream_mode = false;
    const size_t max_in_samples = 1U;
    // note that buffer size is rounded up to a multiple of
    // lcm(sizeof(Pdu<T>), getpagesize()), but different values that round up to
    // the same number give slightly different performance
    const size_t out_buff_size = 1U;
    auto packet_transmitter_pdu = gr::packet_modem::PacketTransmitterPdu(
        fg, stream_mode, samples_per_symbol, max_in_samples, out_buff_size);
    auto& packet_to_stream =
        fg.emplaceBlock<gr::packet_modem::PacketToStream<gr::packet_modem::Pdu<c64>>>();
    // Limit the number of samples that packet_to_stream can produce in one
    // call. Otherwise it produces 65536 items on the first call, and then "it
    // gets behind the Throttle block" by these many samples.
    packet_to_stream.out.max_samples = 1000U;
    auto& throttle = fg.emplaceBlock<gr::packet_modem::Throttle<c64>>(
        { { "sample_rate", samp_rate }, { "maximum_items_per_chunk", 1000UZ } });
    auto& probe_rate = fg.emplaceBlock<gr::packet_modem::ProbeRate<c64>>();
    auto& message_debug = fg.emplaceBlock<gr::packet_modem::MessageDebug>();
    // scale the resampler taps to have a gain of 1 per arm
    std::vector<float> resampler_taps;
    for (auto x : pfb_arb_taps) {
        resampler_taps.push_back(32.0f * x);
    }
    auto& resampler = fg.emplaceBlock<gr::packet_modem::PfbArbResampler<c64, c64, float>>(
        { { "taps", resampler_taps }, { "rate", 1.0f + 1e-6f * sfo_ppm } });
    auto& rotator =
        fg.emplaceBlock<gr::packet_modem::Rotator<>>({ { "phase_incr", freq_error } });
    auto& noise_source = fg.emplaceBlock<gr::packet_modem::NoiseSource<c64>>(
        { { "noise_type", "gaussian" }, { "amplitude", noise_amplitude } });
    auto& add_noise = fg.emplaceBlock<gr::packet_modem::Add<c64>>();
    const bool header_debug = false;
    const bool zmq_output = true;
    const bool log = true;
    auto packet_receiver = gr::packet_modem::PacketReceiver(
        fg, samples_per_symbol, "packet_len", header_debug, zmq_output, log);
    auto& tag_to_pdu = fg.emplaceBlock<gr::packet_modem::TaggedStreamToPdu<uint8_t>>();
    auto& sink = fg.emplaceBlock<gr::packet_modem::TunSink>(
        { { "tun_name", "gr4_tun_rx" }, { "netns_name", "gr4_rx" } });

    expect(eq(gr::ConnectionResult::SUCCESS,
              source.out.connect(*packet_transmitter_pdu.in)));
    expect(eq(gr::ConnectionResult::SUCCESS,
              packet_transmitter_pdu.out_packet->connect(packet_to_stream.in)));
    expect(eq(gr::ConnectionResult::SUCCESS,
              fg.connect<"out">(packet_to_stream).to<"in">(resampler)));
    expect(eq(gr::ConnectionResult::SUCCESS,
              fg.connect<"out">(resampler).to<"in">(throttle)));
    expect(eq(gr::ConnectionResult::SUCCESS,
              fg.connect<"out">(throttle).to<"in">(probe_rate)));
    expect(
        eq(gr::ConnectionResult::SUCCESS, probe_rate.rate.connect(message_debug.print)));
    expect(
        eq(gr::ConnectionResult::SUCCESS, fg.connect<"out">(throttle).to<"in">(rotator)));
    expect(eq(gr::ConnectionResult::SUCCESS,
              fg.connect<"out">(rotator).to<"in0">(add_noise)));
    expect(eq(gr::ConnectionResult::SUCCESS,
              fg.connect<"out">(noise_source).to<"in1">(add_noise)));
    expect(eq(gr::ConnectionResult::SUCCESS, add_noise.out.connect(*packet_receiver.in)));
    expect(
        eq(gr::ConnectionResult::SUCCESS, packet_receiver.out->connect(tag_to_pdu.in)));
    expect(
        eq(gr::ConnectionResult::SUCCESS, fg.connect<"out">(tag_to_pdu).to<"in">(sink)));

    gr::scheduler::Simple<gr::scheduler::ExecutionPolicy::singleThreaded> sched{
        std::move(fg)
    };
    const auto ret = sched.runAndWait();
    expect(ret.has_value());
    if (!ret.has_value()) {
        fmt::println("scheduler error: {}", ret.error());
    }

    return 0;
}
